<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <link rel="stylesheet" type="text/css" href="http://yui.yahooapis.com/3.7.2/build/cssreset/cssreset-min.css" />
        <link rel="stylesheet" type="text/css" href="css/e3Radio.css" />
        <title>e3Radio</title>
    </head>
    <body>
        
        <div class="wrapper">
          <div id="e3r"></div>
        </div> 
        <div id="modal"></div>

        <!-- templates -->

        <script type="text/html" id="logo">
          <h1>e3Radio.</h1>
        </script>

        <script type="text/html" id="header">
          <header>
            <menu>
             <!-- <ul>
                <li><a href="#">Login</a></li>
              </ul> -->
            </menu> 
            <%= logo %>
          </header>
          <div id="request">
            <form>
              <input type="text" name="request" placeholder="Democratically building the ultimate e3 playlist...">
            </form>
          </div>
        </script>

        <script type="text/html" id="track-detail">
          <div class="detail">Track / <%= TrackID %></div>
          <span class="info">
            <span class="artist"><em><%= Artist %></em></span>
            <span class="title"><em><%= TrackName %></em></span>
          </span>
        </script>

        <script type="text/html" id="track-list">
            <li data-track-id="<%= TrackID %>">
              <p style=" <%= PictureExtraLarge ? 'background-image: url(' + PictureExtraLarge +')' : '' %>" data-id="">
                <span class="number"><%= i %></span>
                <span class="info">
                  <span class="artist"><em><%= Artist %></em></span>
                  <span class="title"><em><%= TrackName %></em></span>
                </span>
              </p>
            </li>
        </script>

        <script type="text/html" id="chart">
          <ul id="tracks"></ul>
        </script>

        <script type="text/html" id="page">
          <%= header %>
          <div class="content">
            <article>
              <div id="content"></div>
              <div class="clear"></div>
            </article>
          </div>
          <%= footer %>
        </script>

        <script type="text/html" id="footer">
          <footer>
            <p><a href="http://e3.co.uk">http://e3.co.uk</a></p>
          </footer> 
        </script>        

        <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
        <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.3.3/underscore-min.js"></script>
        <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/json2/20110223/json2.js"></script>
        <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/backbone.js/0.9.2/backbone-min.js"></script>
        <script type="text/javascript" src="js/debug.js"></script>
        <script type="text/javascript">

          var channel = (function(){

            var stack = [];

            return {
              publish: function(e){
                $.each(stack, function(){
                  if(this.event.search(e.event) > -1){
                    this.cb.call(this.inst, e.data);
                  }
                })
              },
              subscribe: function(i, data){
                stack.push(_.extend({
                  inst: i
                }, data));
              },
              unsubscribe: function(obj, event){
                var i = 0;
                for(o in stack){
                  if(o.inst == obj){ 
                    stack.splice(i, 1);
                  }
                  i++;
                }
              } 
            }

          })();

          /////////////////////////////////

          var playQueue = function(){

            this.tracks;
            var that = this;

            channel.subscribe(this, {
              event: 'init-playQueue',
              cb: function(data){
                this.ini(data);
              }
            });

            channel.subscribe(this, {
              event: 'add-request',
              cb: function(data){
                this.add(data);
              }
            });

            channel.subscribe(this, {
              event: 'move-playhead',
              cb: function(){
                this.pop();
              }
            });

          }
          playQueue.prototype.pop = function(){
            // console.log('pop');
            this.tracks.reverse();  
            this.tracks.pop();
            this.tracks.reverse();
            this.finished();
          } 
          playQueue.prototype.ini = function(data){
            this.tracks = data;
            this.initialised();
            this.finished();
          }
          playQueue.prototype.add = function(data){
            // console.log('add');
            var that = this;
            $.each(data, function(){
              that.tracks.splice(1, 0, this);
            });
            this.finished();
          }
          playQueue.prototype.finished = function(){
            var that = this;
            channel.publish({ 
              event: 'after-playQueueUpdate', 
              data: that.tracks 
            });
          }
          playQueue.prototype.initialised = function(){
            channel.publish({ 
              event: 'playQueue-initialised'
            });
          }
          playQueue.prototype.fetch = function(cb){
            if(this.tracks){
              this.finished();
            } else {
              $.getJSON('data/playQueue.json', function(data){
                channel.publish({
                  event: 'init-playQueue',
                  data: data
                });
              });
            }
          }
          playQueue.prototype.trackByID = function(id){

          }

          //////////////////////////////////////////////////////////

          var modal = function(){

            this.$inst = $('#modal');

            channel.subscribe(this, {
              event: 'after-draw',
              cb: function(){
                this.$inst.hide();
              }
            });

          };

          //////////////////////////////////////////////////////////

          var page = function(){
            $('h1').live('click', function(){
              Backbone.history.navigate('', true); 
            });
            channel.subscribe(this, {
              event: 'playQueue-initialised',
              cb: function(){
                this.chrome();
              }
            })
          }
          page.prototype.chrome = function(){
            var t = this;
            var logo = { logo: t.t('logo') };
            $('#e3r').empty().html(t.t('page', $.extend({}, {
              header: t.t('header', logo),
              footer: t.t('footer')
            })));
            channel.publish({
              event: 'after-chrome'
            })
          }
          page.prototype.t = function(id, data){
            return _.template($('#'+id).html(), data || {});
          }

          //////////////////////////////////////////////////////////

          var track = function(data){
            this.id;
            this.data = data;
          }
          track.prototype.html = function(view){
            return _.template($('#track-'+view).html(), this.data);
          }
          track.prototype.draw = function(data, id){
            this.data = this.byID(data, id);
            $('#content').empty().html(this.html('detail'));
            channel.publish({
              event: 'after-draw'
            });
          }
          track.prototype.bind = function(id){
            channel.subscribe(this, {
              event: 'after-playQueueUpdate',
              cb: function(data){
                this.draw(data, id);
              }
            });
          }
          track.prototype.unbind = function(){
            channel.unsubscribe(this);
          }
          track.prototype.byID = function(data, id){
            for(var i = 0; i < data.length; i++){
              if(data[i].TrackID == id) return data[i];
            }
          }

          //////////////////////////////////////////////////////////

          var chart = function(){
            $('#tracks li').live('click', function(){
              Backbone.history.navigate('track/' + $(this).data('track-id'), true); 
            });
          }
          chart.prototype.draw = function(data){
            var $ul = $($('#chart').html()).appendTo($('#content').empty());
            var i = 1;

            $.each(data, function(){
              var t = new track($.extend(this, { i: i++ }));
              $ul.append(t.html('list'));
            });

            channel.publish({
              event: 'after-draw'
            })
          }
          chart.prototype.bind = function(){
            channel.subscribe(this, {
              event: 'after-playQueueUpdate',
              cb: function(data){
                this.draw(data);
              }
            });
          }
          chart.prototype.unbind = function(){
            channel.unsubscribe(this);
          }

          //////////////////////////////////////////////////////////

          channel.subscribe(this, {
            event: 'after-chrome',
            cb: function(){

             $('[placeholder]').each(function(){
               var $ths = $(this),
                    scrpt = $ths.attr('placeholder') + '        ',
                    chr, str, reset = function() {
                      str = ' > ';
                      chr = 0;
                    },
                    set = function() {
                      if (scrpt[chr]) {
                        str += scrpt[chr++];
                      } else {
                        reset();
                      }
                      $ths.attr('placeholder', str);
                    },
                    tck = function() {
                      setTimeout(function() {
                        set();
                        tck();
                      }, 200);
                    };

                reset();
                set();
                tck();
  
              });
            }
          }); 

          ///////////////////////////

          var router = Backbone.Router.extend({
            routes: {
              "track/:id": "track",
              "*actions": "defaultRoute"
            }
          });
          
          var RTR = new router;
          var PLQ = new playQueue;
          var MDL = new modal;
          var PGE = new page;
          var CHT = new chart;
          var TRK = new track;

          ///////////////////////////

          RTR.on('route:track', function (id) {
            CHT.unbind();
            TRK.bind(id);
            PLQ.fetch();
          });

          RTR.on('route:defaultRoute', function (actions) {
            CHT.bind();
            TRK.unbind();
            PLQ.fetch();
          });
          
          Backbone.history.start();           

        </script>

    </body>
</html>