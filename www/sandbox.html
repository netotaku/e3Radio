<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <link rel="stylesheet" type="text/css" href="http://yui.yahooapis.com/3.7.2/build/cssreset/cssreset-min.css" />
        <link rel="stylesheet" type="text/css" href="css/e3Radio.css" />
        <title>e3Radio</title>
    </head>
    <body>
        
        <div class="wrapper">
          <div id="e3r"></div>
        </div> 
        <div id="modal"></div>

        <!-- templates -->

        <script type="text/html" id="logo">
          <h1>e3Radio.</h1>
        </script>

        <script type="text/html" id="header">
          <header>
            <menu>
             <!-- <ul>
                <li><a href="#">Login</a></li>
              </ul> -->
            </menu> 
            <%= logo %>
          </header>
          <div id="request">
            <form>
              <input type="text" name="request" placeholder="Democratically building the ultimate e3 playlist...">
            </form>
          </div>
        </script>

        <script type="text/html" id="chart">
          <ul id="tracks">
            <% 
              var i = 1;
              $.each(tracks, function(){ %>
              <li data-track-id="<%= this.TrackID %>">
                <p style=" <%= this.PictureExtraLarge ? 'background-image: url(' + this.PictureExtraLarge +')' : '' %>" data-id="<%= this.TrackPlayedID %>">
                  <span class="number"><%= i++ %></span>
                  <span class="info">
                    <span class="artist"><em><%= this.Artist %></em></span>
                    <span class="title"><em><%= this.TrackName %></em></span>
                  </span>
                </p>
              </li>
            <% }) %>
          </ul>
        </script>

        <script type="text/html" id="page">
          <%= header %>
          <div class="content">
            <article>
              <%= article %>  
              <div class="clear"></div>
            </article>
          </div>
          <%= footer %>
        </script>

        <script type="text/html" id="footer">
          <footer>
            <p><a href="http://e3.co.uk">http://e3.co.uk</a></p>
          </footer> 
        </script>        

        <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
        <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.3.3/underscore-min.js"></script>
        <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/json2/20110223/json2.js"></script>
        <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/backbone.js/0.9.2/backbone-min.js"></script>
        <script type="text/javascript" src="js/debug.js"></script>
        <script type="text/javascript">

          var channel = (function(){

            var stack = [];

            return {
              publish: function(e){
                $.each(stack, function(){
                  if(this.event.search(e.event) > -1){
                    this.cb.call(this.inst, e.data);
                  }
                })
              },
              subscribe: function(i, data){
                stack.push(_.extend({
                  inst: i
                }, data));
              }
            }

          })();

          /////////////////////////////////

          var playQueue = function(){

            this.tracks;
            var that = this;

            channel.subscribe(this, {
              event: 'init-playQueue',
              cb: function(data){
                this.ini(data);
              }
            });

            channel.subscribe(this, {
              event: 'add-request',
              cb: function(data){
                this.add(data);
              }
            });

            channel.subscribe(this, {
              event: 'move-playhead',
              cb: function(){
                this.pop();
              }
            });

          }
          playQueue.prototype.pop = function(){
            // console.log('pop');
            this.tracks.reverse();  
            this.tracks.pop();
            this.tracks.reverse();
            this.finished();
          } 
          playQueue.prototype.ini = function(data){
            this.tracks = data;
            this.finished();
          }
          playQueue.prototype.add = function(data){
            // console.log('add');
            var that = this;
            $.each(data, function(){
              that.tracks.splice(1, 0, this);
            });
            this.finished();
          }
          playQueue.prototype.finished = function(){
            var that = this;
            channel.publish({ event: 'after-playQueueUpdate', data: that.tracks });
          }

          new playQueue;

          //////////////////////////////////////////////////////////

          var modal = function(){

            this.$inst = $('#modal');

            channel.subscribe(this, {
              event: 'after-chartDraw',
              cb: function(){
                this.$inst.hide();
              }
            });

          };

          new modal;

          var page = (function(){
         
            var t = function(id, data){
              return _.template($('#'+id).html(), data || {});
            }

            return {
              set: function(id, data){
                var logo = { logo: t('logo') };
                $('#e3r').html(t('page', $.extend({}, {
                  header: t('header', $.extend(data, logo)),
                  article: t(id, data || {}),
                  footer: t('footer')
                })));
              }
            }
          })();

          //////////////////////////////////////////////////////////

          var chart = function(){

            channel.subscribe(this, {
              event: 'after-playQueueUpdate',
              cb: function(data){
                this.draw(data);
              }
            })

          };
          chart.prototype.draw = function(data){
            page.set('chart', { tracks: data });
            channel.publish({
              event: 'after-chartDraw'
            })
          }

          new chart;

          //////////////////////////////////////////////////////////

          channel.subscribe(this, {
            event: 'after-chartDraw',
            cb: function(){

             $('[placeholder]').each(function(){
               var $ths = $(this),
                    scrpt = $ths.attr('placeholder') + '        ',
                    chr, str, reset = function() {
                      str = ' > ';
                      chr = 0;
                    },
                    set = function() {
                      if (scrpt[chr]) {
                        str += scrpt[chr++];
                      } else {
                        reset();
                      }
                      $ths.attr('placeholder', str);
                    },
                    tck = function() {
                      setTimeout(function() {
                        set();
                        tck();
                      }, 200);
                    };

                reset();
                set();
                tck();
  
              });
            }
          });  

        </script>

    </body>
</html>