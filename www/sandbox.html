<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <link rel="stylesheet" type="text/css" href="http://yui.yahooapis.com/3.7.2/build/cssreset/cssreset-min.css" />
        <link rel="stylesheet" type="text/css" href="css/e3Radio.css" />
        <title>e3Radio</title>
    </head>
    <body>
        
        <div class="wrapper">
          <div id="e3r"></div>
        </div> 

        <!-- templates -->

        <script type="text/html" id="logo">
          <h1>e3Radio.</h1>
        </script>

        <script type="text/html" id="header">
          <header>
            <menu>
             <!-- <ul>
                <li><a href="#">Login</a></li>
              </ul> -->
            </menu> 
            <%= logo %>
          </header>
        </script>

        <script type="text/html" id="chart">
          <ul id="tracks">
            <% 
              var i = 1;
              $.each(tracks, function(){ %>
              <li data-track-id="<%= this.TrackID %>">
                <p style="background-image: <%= this.PictureExtraLarge ? 'url(' + this.PictureExtraLarge +')' : 'none' %>" data-id="<%= this.TrackPlayedID %>">
                  <span class="number"><%= i++ %></span>
                  <span class="info">
                    <span class="artist"><em><%= this.Artist %></em></span>
                    <span class="title"><em><%= this.TrackName %></em></span>
                  </span>
                </p>
              </li>
            <% }) %>
          </ul>
        </script>

        <script type="text/html" id="page">
          <%= header %>
          <div class="content">
            <article>
              <%= article %>  
              <div class="clear"></div>
            </article>
          </div>
          <%= footer %>
        </script>

        <script type="text/html" id="footer">
          <footer>
            <p><a href="http://e3.co.uk">http://e3.co.uk</a></p>
          </footer> 
        </script>        

        <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
        <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.3.3/underscore-min.js"></script>
        <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/json2/20110223/json2.js"></script>
        <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/backbone.js/0.9.2/backbone-min.js"></script>
        <script type="text/javascript" src="js/debug.js"></script>
        <script type="text/javascript">

          var channel = (function(){

            var stack = [];

            return {
              publish: function(e){
                $.each(stack, function(){
                  if(this.event == e.event){
                    this.cb.call(this.inst, e.data);
                  }
                })
              } ,
              subscribe: function(i, data){
                stack.push(_.extend({
                  inst: i
                }, data));
              }
            }

          })();

          /////////////////////////////////

          var playQueue = function(){

            this.tracks;

            channel.subscribe(this, {
              event: 'init-playQueue',
              cb: function(data){
                this.ini(data);
              }
            });

            channel.subscribe(this, {
              event: 'add-request',
              cb: function(data){
                this.add(data);
              }
            });

            channel.subscribe(this, {
              event: 'move-playhead',
              cb: function(){
                this.pop();
              }
            });

          }
          playQueue.prototype.pop = function(){
            this.tracks.reverse();
            this.tracks.pop();
            this.tracks.reverse();
            this.draw();
          } 
          playQueue.prototype.ini = function(data){
            this.tracks = data;
            this.draw();
          }
          playQueue.prototype.add = function(data){
            this.tracks.splice(1, 0, data[0]);
            this.draw();
          },
          playQueue.prototype.draw = function(){
            var that = this;
            channel.publish({
              event: 'draw-chart',
              data: that.tracks
            });
          }

          new playQueue;

          //////////////////////////////////////////////////////////

          var page = (function(){

            var t = function(id, data){
              return _.template($('#'+id).html(), data || {});
            }

            return {
              set: function(id, data){
                var logo = { logo: t('logo') };
                $('#e3r').html(t('page', $.extend({}, {
                  header: t('header', $.extend(data, logo)),
                  article: t(id, data || {}),
                  footer: t('footer')
                })));
              }
            }
          })();

          //////////////////////////////////////////////////////////

          var chart = function(){

            channel.subscribe(this, {
              event: 'draw-chart',
              cb: function(data){
                this.draw(data);
              }
            })

          };
          chart.prototype.draw = function(data){
            page.set('chart', { tracks: data });
          }

          new chart;

        </script>

    </body>
</html>